---
slug: MySQL-Journey
title: MySQLä¹‹æ—…
author: Stitch-Zhang
author_title: An iddle programer
author_url: https://github.com/Stitch-Zhang
author_image_url: https://avatars1.githubusercontent.com/u/61350804?s=460&v=4
tags: [MySQL,CentOS]
---

`MySQL`ç»éªŒå°ç»“

<!--truncate-->

# CentOSå®‰è£…ç¤¾åŒºç‰ˆMySQL 

## ä¸‹è½½

å‰å¾€ä¸­[ä¸‹è½½é¡µé¢é“¾æ¥](https://downloads.mysql.com/archives/community/)

å…¶ä¸­åŒ…å«æ‰€æœ‰ç‰ˆæœ¬çš„`Mysql`ï¼Œé€‰æ‹©éœ€è¦çš„ç‰ˆæœ¬å’Œå½“å‰çš„ç³»ç»Ÿç±»å‹

å¦‚æˆ‘çš„æ˜¯é€‰æ‹©`5.7.10`ç‰ˆæœ¬çš„ï¼Œåœ¨`RHEL(CentOS)`ä¸Šé£Ÿç”¨

![image-20210914103916166](https://s2.loli.net/2022/02/15/P3QizcMjdES8NGr.png)

ä¸‹è½½é€‰çš„ç»¼åˆåŒ…ï¼Œå…¶ä¸­åŒ…å«é¡µé¢ä¸Šæ˜¾ç¤ºçš„æ‰€æœ‰åŒ…

å…¶ä¸­åŒ…å«

| åŒ…å                              |           åŠŸèƒ½            |
| :-------------------------------- | :-----------------------: |
| **mysql-community-client**        |      æä¾›å®¢æˆ·ç«¯å‘½ä»¤       |
| **mysql-community-libs**          |          ä¾èµ–åº“           |
| **mysql-community-common**        |         é€šç”¨ä¾èµ–          |
| **mysql-community-libs-compat**   |      å®¢æˆ·ç«¯çš„å…¼å®¹åº“       |
| **mysql-community-server**        |   æœåŠ¡å™¨ç¨‹åºå’Œç›¸å…³å·¥å…·    |
| mysql-community-devel             | å¼€å‘MySQLå¿…å¤‡çš„å¤´æ–‡ä»¶å’Œåº“ |
| mysql-community-minimal-debuginfo |    æœ€å°å®‰è£…è°ƒå¼ä¿¡æ¯åº“     |
| mysql-community-embedded          |         åµŒå…¥å¼åº“          |
| mysql-community-embedded-compat   |     åµŒå…¥å¼å…±äº«å…¼å®¹åº“      |
| mysql-community-test              |         æµ‹è¯•å¥—ä»¶          |
| mysql-community-embedded-devel    |   åµŒå…¥å¼å¼€å‘åº“å’Œå¤´æ–‡ä»¶    |

## å®‰è£…

### ä½¿ç”¨yumå®‰è£…

è¡¨æ ¼ä¸­æ ‡æ³¨**ç²—ä½“**çš„éƒ½ä¸ºå¿…é¡»å®‰è£…çš„åŒ…

```shell
yum install mysql-community-{client,libs,common,libs-compat,server}*
```

![image-20210914162403614](https://s2.loli.net/2022/02/15/a8Lcgyzqfext6FJ.png)

>  ä¸å»ºè®®ä½¿ç”¨rpmè¿›è¡Œå®‰è£…ï¼ŒåŒ…ä¹‹é—´ä¾èµ–å…³ç³»å¤æ‚ï¼Œå®‰è£…ç¹ç

![preview](https://s2.loli.net/2022/02/15/CGXYvBz1SbFkfsx.jpg)

[^å›¾ç‰‡å¼•ç”¨äº]: https://zhuanlan.zhihu.com/p/34719781

### å¯åŠ¨æœåŠ¡

```shell
systemctl start mysqld
```

### æŸ¥çœ‹çŠ¶æ€

```she
systemctl status mysqld
```

![image-20210914165611928](https://s2.loli.net/2022/02/15/HeAzuUBJOiNjXQf.png)



## é…ç½®

### [å¯é€‰]æ›´æ”¹æ•°æ®åº“æ–‡ä»¶å¤¹

é…ç½®æ–‡ä»¶`/etc/my.cnf`ä¸­`datadir`å­—æ®µï¼Œå¦‚æˆ‘å°†æŠŠæ•°æ®åº“å­˜æ”¾æ”¹åˆ°`/dbdata`ä¸­

![image-20210914171027868](https://s2.loli.net/2022/02/15/Me7CUnbT8EuSDYw.png)

### é‡å¯æœåŠ¡

```she
systemctl restart mysqld
```

### æŸ¥è¯¢å¯†ç 

MySQLç‰ˆæœ¬<=5.7ï¼Œå¯åŠ¨æœåŠ¡åä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª`ä¸´æ—¶å¯†ç `ï¼Œå…¶å­˜åœ¨åœ¨æ—¥å¿—æ–‡ä»¶`/var/log/mysqld.log`ä¸­

å¯é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥è¯¢ 

```shell
cat /var/log/mysqld.log | grep "temporary password" | awk -F ': ' '{print $2}'
```

![image-20210914165020240](https://s2.loli.net/2022/02/15/UEbVS6BypvIgwuJ.png)

### åˆå§‹åŒ–

åˆå§‹åŒ–ä¼šè¦æ±‚è¾“å…¥ä¸´æ—¶å¯†ç 

```shell
mysql_secure_installation
```

### å¯†ç ç­–ç•¥ä¿®æ”¹

ä½¿ç”¨çš„`MySQL 5.7`é»˜è®¤æœ‰å®‰è£…å¯†ç å¼ºåº¦æ ¡éªŒæ’ä»¶`validate_password`

#### æŸ¥è¯¢å½“å‰ç­–ç•¥ä¿¡æ¯

å¯†ç ç­–ç•¥é…ç½®åœ¨å…¨å±€å˜é‡ä¸­ï¼Œå¯é€šè¿‡æŸ¥çœ‹å…¶å˜é‡å€¼æ¥ç¡®å®š

```mysql
mysql > show variables like 'validate_password%';
```

![image-20210914171956752](https://s2.loli.net/2022/02/15/Chgtiz1d2OqL6nF.png)

| å˜é‡                                 | å€¼æ„                       |
| ------------------------------------ | -------------------------- |
| validate_password_dictionary_file    | æ£€æŸ¥å¯†ç çš„å­—å…¸æ–‡ä»¶çš„è·¯å¾„å |
| validate_password_length             | æœ€çŸ­å¯†ç é•¿åº¦               |
| validate_password_mixed_case_count   | æœ€å°‘å¤§å°å†™å­—ç¬¦å¯¹æ•°         |
| validate_password_number_count       | æœ€å°‘æ•°å­—æ•°ç›®               |
| **validate_password_policy**         | å¯†ç ç­–ç•¥                   |
| validate_password_special_char_count | æœ€å°‘ç‰¹æ®Šå­—ç¬¦æ•°             |

**å¯†ç ç­–ç•¥**

| ç­–ç•¥ç­‰çº§ | æè¿°                                         |
| -------- | -------------------------------------------- |
| 0/LOW    | åªæ£€æŸ¥é•¿åº¦                                   |
| 1/MEDIUM | æ£€æŸ¥é•¿åº¦ã€æ•°å­—ã€å¤§å°å†™ã€ç‰¹æ®Šå­—ç¬¦             |
| 2/STRONG | æ£€æŸ¥é•¿åº¦ã€æ•°å­—ã€å¤§å°å†™ã€ç‰¹æ®Šå­—ç¬¦ã€å­—å…¸æ–‡ä»¶ã€‚ |

[^éƒ¨åˆ†ä¿¡æ¯å¼•å…¥äº]: https://www.cnblogs.com/kerrycode/p/13501292.html

#### ä¿®æ”¹ç­–ç•¥

å°†ä¿®æ”¹`å¯†ç ç­–ç•¥`ä¸º`LOW`

```mysql
mysql > set global validate_password_policy=LOW;
```

> åœ¨ä¿®æ”¹ç­–ç•¥ä¹‹å‰åˆ›å»ºçš„ç”¨æˆ·å¯†ç ä¸å—å½±å“
>
> ä¿®æ”¹ç­–ç•¥åï¼Œå†è¿›è¡Œåˆ›å»ºçš„ç”¨æˆ·ï¼Œå°†å—åˆ°å½±å“

#### ç®€å•ç²—æš´

å¦‚æœè§‰å¾—ä¸Šé¢ç¹çï¼Œå¯ç›´æ¥å¸è½½æ’ä»¶

```mysql
mysql > uninstall plugin validate_password
```

å¸è½½åæ–°å¢ç”¨æˆ·ï¼Œå…¶å¯†ç æ²¡æœ‰ä»»ä½•é™åˆ¶

### ä¿®æ”¹å¯†ç 

rootç”¨æˆ·åªèƒ½ä¿®æ”¹ä¸ºæœ¬åœ°è®¿é—®

```mysql
mysql > alter user 'root'@'localhost' identified by '123456';
```



### è®¾ç½®æœ€å¤§è¿æ¥æ•°

#### æŸ¥çœ‹å½“å‰æœ€å¤§è¿æ¥æ•°

```shell
mysql > show variables like 'max_connections';
```

#### è®¾ç½®æœ€å¤§è¿æ¥æ•°

å¦‚ä¸‹è®¾ç½®æœ€å¤§è¿æ¥æ•°ä¸º`500`

```mysql
mysql > set global max_connections=500;
```



### é£Ÿç”¨ğŸ¥¢

#### å»ºåº“å¹¶é…ç½®ç”¨æˆ·

å¦‚ä¸‹åˆ›å»º`expirement`æ•°æ®åº“ï¼Œåˆ›å»ºå¹¶èµ‹äºˆç”¨æˆ·`stitch`æ‰€æœ‰æƒé™

> æ‰€æœ‰æƒé™ï¼š
>
> selectï¼Œinsertï¼Œupdateï¼Œdelete ï¼Œcreateï¼Œdropï¼Œreferences
>
> indexï¼Œalterï¼Œcreate temporary tablesï¼Œlock tablesï¼Œexecute 
>
> create viewï¼Œshow viewï¼Œcreate routineï¼Œalter routineï¼Œeventï¼Œtrigger

#### åˆ›å»ºæ•°æ®åº“

```mysql
mysql > create database expirement;
```

#### æ•°æ®åº“æˆæƒ

##### åˆ›å»ºä¸ç”¨æˆ·å¹¶æˆæƒ

é€šè¿‡è¯¥å‘½ä»¤åˆ›å»ºçš„ç”¨æˆ·ï¼Œå…¶é»˜è®¤å…è®¸ä»»æ„IPè¿æ¥

```mysql
mysql > grant all privileges on expirement.* to stitch identified by '123456';
```

##### è®¾ç½®é™åˆ¶IPè¿æ¥

é™åˆ¶å®¢æˆ·ç«¯IPä¸º`192.168.1.*`

```mysql
mysql > grant all privileges on expirement.* to stitch@'192.168.1.*' identified by '123456';
```

### å¯ç”¨SSLé€šä¿¡

`MySQL`åœ¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨ç”ŸæˆSSLç›¸å…³è¯ä¹¦äº`æ•°æ®åº“æ–‡ä»¶å¤¹`ï¼Œå¹¶å¯ç”¨SSLç”¨äºåŠ å¯†æ•°æ®ä¼ è¾“

è€Œ`MariaDB`ä¸­SSLé»˜è®¤æœªé…ç½®ï¼Œä¸”ä¸ºå…³é—­çŠ¶æ€ï¼Œéœ€è¦æ‰‹åŠ¨ç”Ÿæˆè¯ä¹¦å’Œæ–°å¢é…ç½®æ–‡ä»¶

#### ç”ŸæˆCAç§é’¥å’ŒCAè¯ä¹¦

**è¯ä¹¦æ ¼å¼ï¼šx509**

##### CAç§é’¥

```shell
openssl genrsa 2048 > ca-key.pem 
```

##### CAè¯ä¹¦

ä½¿ç”¨åˆšåˆšçš„ç§é’¥è¿›è¡Œåˆ›å»º

```shell
openssl req -new -x509 -nodes -days 365000 -key ca-key.pem -out ca.pem
```

å› ä¸ºæ˜¯è‡ªç­¾CAè¯ä¹¦ï¼Œå°†è¦æ±‚å¡«å…¥CAæœºæ„ä¿¡æ¯

#### ç”Ÿæˆç§é’¥å’Œè¯ä¹¦ç”Ÿæˆè¯·æ±‚

```shell
openssl req -newkey rsa:2048 -days 365000 -nodes -keyout server-key.pem -out server-req.pem
```

å°†ç”Ÿæˆ

- `server-key.pem` è¯ä¹¦ç§é’¥
- `server-req.pem` è¯ä¹¦ç”Ÿæˆè¯·æ±‚

##### ç§é’¥é¢„å¤„ç†

åˆ é™¤ç§é’¥`å¯†ç çŸ­è¯­`

```shell
openssl rsa -in server-key.pem -out server-key.pem
```

#### è¯ä¹¦ç­¾å

ä½¿ç”¨ç”Ÿæˆçš„`CAç§é’¥`ã€`CAè¯ä¹¦`å°†`è¯ä¹¦ç”Ÿæˆè¯·æ±‚`è¿›è¡Œç­¾åç”Ÿæˆè¯ä¹¦

```shell
openssl x509 -req -in server-req.pem -days 365000 \
      -CA ca.pem -CAkey ca-key.pem -set_serial 01 \
      -out server-cert.pem
```

#### å†™å…¥é…ç½®

##### MariaDB

`/etc/my.cnf.d/server.cnf`

```shell
[mariadb]
ssl_cert = <è¯ä¹¦è·¯å¾„> -> server-cert.pem
ssl_Key = <ç§é’¥è·¯å¾„>  -> server-key.pem
ssl_ca = <CAè¯ä¹¦è·¯å¾„> -> ca.pem
```

##### é‡å¯æœåŠ¡

```shell
systemctl restart mysqld/mariadb
```



### ç”¨æˆ·SSLåŠ å¯†ç™»å½•

#### è·å–æœåŠ¡å™¨SSLé…ç½®ä¿¡æ¯

```mysql
mysql > show variables like '%ssl%';

+---------------+--------------------------------+
| Variable_name | Value                          |
+---------------+--------------------------------+
| have_openssl  | YES         ç³»ç»Ÿæ˜¯å¦å«æœ‰openssl  |
| have_ssl      | YES         æ˜¯å¦å¯ç”¨SSL          |
| ssl_ca        | /var/lib/mysql/ca.pem CAè¯ä¹¦è·¯å¾„ |
| ssl_capath    |                                |
| ssl_cert      | /var/lib/mysql/server-cert.pem |
| ssl_cipher    |                                |
| ssl_crl       |                                |
| ssl_crlpath   |                                |
| ssl_key       | /var/lib/mysql/server-key.pem  |
+---------------+--------------------------------+
```

`have_ssl`å¿…é¡»ä¸º`YES`çŠ¶æ€æ‰èƒ½ä½¿ç”¨SSLï¼Œè‹¥æœªå¯ç”¨è¯·å‚è€ƒ

#### å¯ç”¨å¹¶é…ç½®SSL

ä½¿ç”¨`MySQL 5.7`å†…ç½®çš„å‘½ä»¤æ¥å®Œæˆé…ç½®

```shell
mysql_ssl_rsa_setup
```

æ­¤å·¥å…·å°†ä¼šè‡ªåŠ¨ç”ŸæˆMySQLéœ€è¦çš„ç›¸å…³è¯ä¹¦ï¼Œå…¶å­˜æ”¾äº`æ•°æ®åº“æ–‡ä»¶å¤¹`ä¸­ï¼ˆé»˜è®¤åœ¨`/var/lib/mysql`ï¼‰

#### åˆ›å»ºç”¨æˆ·å¹¶è®¾ç½®SSLç™»å½•

```mysql
mysql > grant all privileges on *.* to stitch@'%' identified by '123456' require SSL;
```

åœ¨é…ç½®ç”¨æˆ·SSLç™»å½•åï¼Œç”¨æˆ·ç™»å½•æ—¶éœ€è¦

- CAè¯ä¹¦ï¼ˆCA Certificateï¼‰
- å®¢æˆ·ç«¯å¯†é’¥ ï¼ˆClient Keyï¼‰
- å®¢æˆ·ç«¯è¯ä¹¦ ï¼ˆClient Certificateï¼‰

å¯ä»æ•°æ®åº“æœåŠ¡å™¨ä¸­`æ•°æ®åº“æ–‡ä»¶å¤¹`ä¸­è·å–

![image-20210923152241041](https://s2.loli.net/2022/02/15/5AZOrMPL9beuH8B.png)

#### è¿æ¥æµ‹è¯•

```shell
mysql -u stitch -p -h 0.0.0.0 --ssl-ca=ca.pem --ssl-cert=client-cert.pem --ssl-key=client-key.pem
```

> https://mariadb.com/kb/en/securing-connections-for-client-and-server/

